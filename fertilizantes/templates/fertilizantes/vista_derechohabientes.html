{% extends 'fertilizantes/base.html' %}
{% load get_item %}

{% block title %}Consulta Derechohabientes{% endblock %}

{% block content %}

<style>
    /* Estilos Institucionales */
    .tabla-header-institucional th {
        background-color: #264e46 !important;
        color: #ffffff !important;
        font-weight: 500;
        border: 1px solid rgba(255,255,255,0.1);
        vertical-align: middle;
        white-space: nowrap;
    }

    .contenedor-columnas {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        max-height: 180px; 
        overflow-y: auto;
    }

    .form-section-title {
        color: #264e46;
        font-weight: 700;
        font-size: 0.9rem;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 5px;
        margin-bottom: 15px;
        margin-top: 10px;
    }
    
    /* Estilo Paginaci√≥n */
    .page-link { color: #264e46; }
    .page-item.active .page-link {
        background-color: #264e46;
        border-color: #264e46;
        color: white;
    }
</style>

<div class="container-fluid mt-4 mb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold" style="color: #264e46;">
                <i class="bi bi-people-fill me-2"></i>Consulta de Derechohabientes
            </h1>
            <p class="text-secondary mb-0">
                B√∫squeda avanzada de beneficiarios (Paginaci√≥n Server-Side).
            </p>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> Imprimir
        </button>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-bottom pt-3 pb-2">
            <h6 class="fw-bold text-secondary mb-0">
                <i class="bi bi-sliders me-2"></i>Filtros y Configuraci√≥n
            </h6>
        </div>
        <div class="card-body p-4">
            <form id="form-filtros">
                
                <input type="hidden" name="page" id="page_input" value="1">

                <div class="row g-3 mb-4">
                    <div class="col-12"><div class="form-section-title">üìç Ubicaci√≥n y Periodo</div></div>
                    
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Unidad Operativa</label>
                        <select name="unidad_operativa" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todas --</option>
                            {% for u in unidades %}
                                <option value="{{ u }}" {% if u == unidad_seleccionada %}selected{% endif %}>{{ u }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Estado</label>
                        <select name="estado" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todos --</option>
                            {% for e in estados %}
                                <option value="{{ e }}" {% if e == estado_seleccionada %}selected{% endif %}>{{ e }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted fw-bold">ID CEDA</label>
                        <input name="id_ceda_agricultura" class="form-control border-0 shadow-sm bg-light" value="{{ request.GET.id_ceda_agricultura }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted fw-bold">Fecha Inicio</label>
                        <input type="date" name="fecha_inicio" class="form-control border-0 shadow-sm bg-light" value="{{ request.GET.fecha_inicio }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted fw-bold">Fecha Fin</label>
                        <input type="date" name="fecha_fin" class="form-control border-0 shadow-sm bg-light" value="{{ request.GET.fecha_fin }}">
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12"><div class="form-section-title">üë§ Datos del Beneficiario</div></div>

                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Acuse Estatal</label>
                        <input name="acuse_estatal" class="form-control border-0 shadow-sm bg-light" placeholder="Escribe el acuse..." value="{{ request.GET.acuse_estatal }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">CURP Solicitud</label>
                        <input name="curp_solicitud" class="form-control border-0 shadow-sm bg-light" placeholder="CURP registrada..." value="{{ request.GET.curp_solicitud }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">CURP RENAPO</label>
                        <input name="curp_renapo" class="form-control border-0 shadow-sm bg-light" placeholder="CURP validada..." value="{{ request.GET.curp_renapo }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">B√∫squeda Masiva</label>
                        <textarea name="lista_acuses" rows="1" class="form-control border-0 shadow-sm bg-light" placeholder="Pegar acuses (uno por l√≠nea)..." style="resize: vertical; min-height: 38px;">{{ request.GET.lista_acuses }}</textarea>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-end mb-2">
                            <div class="form-section-title mb-0 border-0">üëÅÔ∏è Columnas a Mostrar</div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="seleccionarTodos(true)">Todas</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="seleccionarTodos(false)">Ninguna</button>
                            </div>
                        </div>
                        
                        <div class="contenedor-columnas">
                            <div class="row row-cols-2 row-cols-md-4 g-2">
                                {% for campo, label in campos %}
                                    <div class="col">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                   id="check_{{ campo }}"
                                                   name="campos" value="{{ campo }}"
                                                   {% if campo in seleccionados %}checked{% endif %}>
                                            <label class="form-check-label small text-secondary" for="check_{{ campo }}">
                                                {{ label }}
                                            </label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12 text-end">
                        <button id="btn-csv" type="button" class="btn btn-success me-2 text-white">
                            <i class="bi bi-file-earmark-excel me-2"></i>Descargar Todo (CSV)
                        </button>
                        <button type="button" onclick="consultarPantalla()" class="btn btn-primary px-5" style="background-color: #264e46; border-color: #264e46;">
                            <i class="bi bi-search me-2"></i>Consultar
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <hr class="my-4">

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive rounded-top" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-hover mb-0 align-middle table-sm">
                    <thead class="tabla-header-institucional" style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            {% for c in seleccionados %}
                                <th class="text-nowrap px-3 py-3">{{ c }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for fila in datos %}
                            <tr>
                                {% for c in seleccionados %}
                                    <td class="text-nowrap px-3 text-secondary">
                                        {{ fila|get_item:c|default:"-" }}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{{ seleccionados|length|default:'1' }}" class="text-center py-5 text-muted">
                                    <i class="bi bi-search fs-1 d-block mb-2"></i>
                                    {% if seleccionados %}
                                        {% if request.GET.unidad_operativa or request.GET.estado %}
                                            No se encontraron resultados con los filtros actuales.
                                        {% else %}
                                            Aplica filtros para iniciar la b√∫squeda.
                                        {% endif %}
                                    {% else %}
                                        Selecciona al menos una columna y aplica filtros.
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if datos.has_other_pages or datos.paginator.count > 0 %}
        <div class="card-footer bg-white py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="small text-muted mb-2 mb-md-0">
                    Mostrando registros <strong>{{ datos.start_index }}</strong> al <strong>{{ datos.end_index }}</strong> 
                    de <strong>{{ datos.paginator.count }}</strong> totales.
                </div>
                
                <nav aria-label="Navegaci√≥n de p√°ginas">
                    <ul class="pagination pagination-sm mb-0">
                        {% if datos.has_previous %}
                            <li class="page-item">
                                <button class="page-link" onclick="irAPagina({{ datos.previous_page_number }})">
                                    &laquo; Anterior
                                </button>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&laquo; Anterior</span></li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                P√°g {{ datos.number }} de {{ datos.paginator.num_pages }}
                            </span>
                        </li>

                        {% if datos.has_next %}
                            <li class="page-item">
                                <button class="page-link" onclick="irAPagina({{ datos.next_page_number }})">
                                    Siguiente &raquo;
                                </button>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">Siguiente &raquo;</span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
  // 1. Consultar (Resetea p√°gina a 1 y env√≠a)
  function consultarPantalla() {
      document.getElementById('page_input').value = "1";
      document.getElementById('form-filtros').submit();
  }

  // 2. Ir a una p√°gina espec√≠fica (Mantiene filtros)
  function irAPagina(num) {
      document.getElementById('page_input').value = num;
      document.getElementById('form-filtros').submit();
  }

  // 3. Descargar CSV
  const btnCsv = document.getElementById('btn-csv');
  if (btnCsv) {
      btnCsv.addEventListener('click', () => {
        const f = document.getElementById('form-filtros');
        
        // Validaci√≥n m√≠nima
        const checkboxes = document.querySelectorAll('input[name="campos"]:checked');
        if (checkboxes.length === 0) {
            alert("Por favor selecciona al menos una columna para exportar.");
            return;
        }
        
        const params = new URLSearchParams(new FormData(f));
        params.append('csv', '1');  // Flag para el backend
        
        // Para descargar TODO, quitamos el par√°metro 'page'
        params.delete('page'); 
        
        window.location = '?' + params.toString();
      });
  }

  // 4. Utilidad Checkboxes
  function seleccionarTodos(valor) {
    const checks = document.querySelectorAll('input[name="campos"]');
    checks.forEach(c => c.checked = valor);
  }
</script>
{% endblock %}