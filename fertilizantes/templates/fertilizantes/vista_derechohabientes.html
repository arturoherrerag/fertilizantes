{% extends 'fertilizantes/base.html' %}
{% load get_item %}

{% block title %}Consulta Derechohabientes{% endblock %}

{% block content %}
<h2 class="mb-3">ðŸ”Ž Consulta de Derechohabientes</h2>

<form id="form-filtros" class="row g-3">

<!-- Filtros â€œgrandesâ€ -->
<div class="col-md-4">
  <label class="form-label">Unidad operativa</label>
  <select name="unidad_operativa" class="form-select">
    <option value="">-- Todas --</option>
    {% for u in unidades %}
      <option value="{{ u }}" {% if u == unidad_seleccionada %}selected{% endif %}>{{ u }}</option>
    {% endfor %}
  </select>
</div>

<div class="col-md-4">
  <label class="form-label">Estado</label>
  <select name="estado" class="form-select">
    <option value="">-- Todos --</option>
    {% for e in estados %}
      <option value="{{ e }}" {% if e == estado_seleccionada %}selected{% endif %}>{{ e }}</option>
    {% endfor %}
  </select>
</div>

<div class="col-md-4">
  <label class="form-label">ID CEDA Agricultura</label>
  <input name="id_ceda_agricultura" class="form-control" value="{{ request.GET.id_ceda_agricultura }}">
</div>

<div class="col-md-4">
  <label class="form-label">Fecha de entrega (inicio)</label>
  <input type="date" name="fecha_inicio" class="form-control" value="{{ request.GET.fecha_inicio }}">
</div>
<div class="col-md-4">
  <label class="form-label">Fecha de entrega (fin)</label>
  <input type="date" name="fecha_fin" class="form-control" value="{{ request.GET.fecha_fin }}">
</div>




  <!-- BÃºsquedas individuales -->
  <div class="col-md-4">
    <label class="form-label">Acuse estatal</label>
    <input name="acuse_estatal" class="form-control">
  </div>
  <div class="col-md-4">
    <label class="form-label">CURP solicitud</label>
    <input name="curp_solicitud" class="form-control">
  </div>
  <div class="col-md-4">
    <label class="form-label">CURP RENAPO</label>
    <input name="curp_renapo" class="form-control">
  </div>

  <!-- Lista de acuses multilÃ­nea -->
  <div class="col-12">
    <label class="form-label">Lista de acuses (uno por lÃ­nea)</label>
    <textarea name="lista_acuses" rows="4" class="form-control"></textarea>
  </div>

<!-- Checklist de columnas -->
<div class="col-12 mb-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <label class="form-label mb-0">Columnas a mostrar</label>
    <div>
      <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="seleccionarTodos(true)">Seleccionar todos</button>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="seleccionarTodos(false)">Desmarcar todos</button>
    </div>
  </div>

  <div style="display: flex; flex-wrap: wrap; max-height: 6.5em; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
    {% for campo,label in campos %}
      <label class="form-check me-4 mb-2">
        <input class="form-check-input" type="checkbox"
               name="campos" value="{{ campo }}"
               {% if campo in seleccionados %}checked{% endif %}>
        {{ label }}
      </label>
    {% endfor %}
  </div>
</div>


  <div class="col-12">
    <button type="submit"  class="btn btn-success">Consultar</button>
    <button id="btn-csv"   type="button" class="btn btn-outline-primary">Descargar CSV</button>
  </div>
</form>

<hr>

<div class="table-responsive" style="max-height: 600px; overflow-x: auto;">
  <table class="table table-striped table-hover table-sm align-middle">
    <thead class="table-light">
      <tr>{% for c in seleccionados %}<th class="text-nowrap">{{ c }}</th>{% endfor %}</tr>
    </thead>
    <tbody>
      {% for fila in datos %}
        <tr>{% for c in seleccionados %}<td class="text-nowrap">{{ fila|get_item:c }}</td>{% endfor %}</tr>
      {% empty %}
        <tr><td colspan="{{ seleccionados|length }}">Sin resultadosâ€¦</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // ðŸ“¥ Descargar CSV
  document.getElementById('btn-csv').addEventListener('click', () => {
    const f = document.getElementById('form-filtros');
    const params = new URLSearchParams(new FormData(f));
    params.append('csv', '1');  // fuerza descarga CSV
    window.location = '?' + params.toString();
  });

  // âœ… Seleccionar o desmarcar todos los checkboxes de campos
  function seleccionarTodos(valor) {
    const checks = document.querySelectorAll('input[name="campos"]');
    checks.forEach(c => c.checked = valor);
  }
</script>
{% endblock %}

