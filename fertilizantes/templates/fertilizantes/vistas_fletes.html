{% extends "fertilizantes/base.html" %}
{% load static %}
{% load get_item %}  

{% block title %}Consulta de Fletes{% endblock %}

{% block content %}

<style>
    /* Estilos Institucionales */
    .tabla-header-institucional th {
        background-color: #264e46 !important;
        color: #ffffff !important;
        font-weight: 500;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    .contenedor-columnas {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        max-height: 180px;
        overflow-y: auto;
    }

    .form-section-title {
        color: #264e46;
        font-weight: 700;
        font-size: 0.9rem;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 5px;
        margin-bottom: 15px;
        margin-top: 10px;
    }
    
    .page-link { color: #264e46; }
    .page-item.active .page-link {
        background-color: #264e46;
        border-color: #264e46;
        color: white;
    }
</style>

<div class="container-fluid mt-4 mb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold" style="color: #264e46;">
                <i class="bi bi-truck me-2"></i>Consulta de Fletes
            </h1>
            <p class="text-secondary mb-0">
                Consulta operativa detallada sobre la Vista Materializada.
            </p>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> Imprimir
        </button>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-bottom pt-3 pb-2">
            <h6 class="fw-bold text-secondary mb-0">
                <i class="bi bi-sliders me-2"></i>Filtros y Configuraci√≥n
            </h6>
        </div>
        <div class="card-body p-4">
            <form id="form-filtros" method="GET">
                <input type="hidden" name="page" id="page_input" value="1">

                <div class="row g-3 mb-4">
                    <div class="col-12"><div class="form-section-title">üìç Ubicaci√≥n</div></div>
                    
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Unidad Operativa</label>
                        <select name="unidad_operativa" id="f_unidad" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todas --</option>
                            </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Estado</label>
                        <select name="estado" id="f_estado" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todos --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Zona Operativa</label>
                        <select name="zona_operativa" id="f_zona" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todas --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">ID CEDA</label>
                        <input name="id_ceda_agricultura" id="f_ceda" list="list_cedas" class="form-control border-0 shadow-sm bg-light" value="{{ filtros.id_ceda_agricultura|default:'' }}">
                        <datalist id="list_cedas"></datalist>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12"><div class="form-section-title">üì¶ Detalle del Flete</div></div>

                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Estatus</label>
                        <select name="estatus" id="f_estatus" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todas --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Producto</label>
                        <select name="producto" id="f_prod" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todos --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Destino Original (CDF)</label>
                        <select name="cdf_destino_original" id="f_cdf_o" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todos --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Destino Final (CDF)</label>
                        <select name="cdf_destino_final" id="f_cdf_f" class="form-select border-0 shadow-sm bg-light">
                            <option value="">-- Todos --</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12"><div class="form-section-title">üìÖ Fechas y Folios</div></div>
                    
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Fecha Salida (Inicio)</label>
                        <input type="date" name="fecha_salida_ini" class="form-control border-0 shadow-sm bg-light" value="{{ filtros.fecha_salida_ini|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Fecha Salida (Fin)</label>
                        <input type="date" name="fecha_salida_fin" class="form-control border-0 shadow-sm bg-light" value="{{ filtros.fecha_salida_fin|default:'' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted fw-bold">Folios (Lista separada por enter)</label>
                        <textarea name="folios_multiline" class="form-control border-0 shadow-sm bg-light" rows="1" placeholder="Ej: 2025-001...">{{ filtros.folios_multiline|default:'' }}</textarea>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-end mb-2">
                            <div class="form-section-title mb-0 border-0">üëÅÔ∏è Columnas a Mostrar</div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="seleccionarTodos(true)">Todas</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="seleccionarTodos(false)">Ninguna</button>
                            </div>
                        </div>
                        
                        <div class="contenedor-columnas">
                            <div class="row row-cols-2 row-cols-md-4 g-2">
                                {% for col in columnas_disponibles %}
                                    <div class="col">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                   id="col_{{ col }}"
                                                   name="columnas" value="{{ col }}"
                                                   {% if col in seleccionadas %}checked{% endif %}>
                                            <label class="form-check-label small text-secondary" for="col_{{ col }}">
                                                {{ col }}
                                            </label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12 text-end">
                        <button id="btn-csv" type="button" class="btn btn-success me-2 text-white">
                            <i class="bi bi-file-earmark-excel me-2"></i>Descargar CSV
                        </button>
                        <button type="button" onclick="consultarPantalla()" class="btn btn-primary px-5" style="background-color: #264e46;">
                            <i class="bi bi-search me-2"></i>Consultar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive rounded-top" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-hover mb-0 align-middle table-sm">
                    <thead class="tabla-header-institucional" style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            {% for c in seleccionadas %}
                                <th class="px-3 py-3">{{ c }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% if datos.object_list %}
                            {% for fila in datos.object_list %}
                                <tr>
                                    {% for col in seleccionadas %}
                                        <td class="px-3 text-secondary" style="white-space: nowrap;">
                                            {{ fila|get_item:col|default:"-" }}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="{{ seleccionadas|length|default:'1' }}" class="text-center py-5 text-muted">
                                    <i class="bi bi-truck fs-1 d-block mb-2"></i>
                                    {% if request.GET %}
                                        No se encontraron fletes con los filtros actuales.
                                    {% else %}
                                        Aplica filtros para consultar.
                                    {% endif %}
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if datos and datos.count > 0 %}
        <div class="card-footer bg-white py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="small text-muted">
                    Mostrando <strong>{{ datos.start_index }}</strong> al <strong>{{ datos.end_index }}</strong> 
                    de <strong>{{ datos.count }}</strong> registros.
                </div>
                
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% if datos.has_previous %}
                            <li class="page-item">
                                <button class="page-link" onclick="irAPagina({{ datos.previous_page_number }})">&laquo;</button>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">P√°g {{ datos.current }} de {{ datos.num_pages }}</span>
                        </li>

                        {% if datos.has_next %}
                            <li class="page-item">
                                <button class="page-link" onclick="irAPagina({{ datos.next_page_number }})">&raquo;</button>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
// Valores actuales seleccionados (vienen de Django template)
const prevValues = {
    unidad: "{{ filtros.unidad_operativa|default:'' }}",
    estado: "{{ filtros.estado|default:'' }}",
    zona: "{{ filtros.zona_operativa|default:'' }}",
    ceda: "{{ filtros.id_ceda_agricultura|default:'' }}",
    estatus: "{{ filtros.estatus|default:'' }}",
    prod: "{{ filtros.abreviacion_producto|default:'' }}",
    cdf_o: "{{ filtros.cdf_destino_original|default:'' }}",
    cdf_f: "{{ filtros.cdf_destino_final|default:'' }}",
};

// Carga as√≠ncrona de opciones para los selects
function loadOptions(){
    // Tomamos lo que est√© en el DOM actual
    const params = new URLSearchParams({
        unidad_operativa: document.getElementById('f_unidad').value,
        estado: document.getElementById('f_estado').value,
        zona_operativa: document.getElementById('f_zona').value
    });

    fetch("{% url 'api_fletes_opciones' %}?" + params.toString())
      .then(r => r.json())
      .then(data => {
        fillSelect('f_unidad', data.unidad_operativa, prevValues.unidad);
        fillSelect('f_estado', data.estado, prevValues.estado);
        fillSelect('f_zona', data.zona_operativa, prevValues.zona);
        
        // Datalist CEDA
        const dl = document.getElementById('list_cedas');
        dl.innerHTML = (data.id_ceda_agricultura || []).map(v => `<option value="${v}">`).join('');

        fillSelect('f_estatus', data.estatus, prevValues.estatus);
        fillSelect('f_prod', data.abreviacion_producto, prevValues.prod);
        fillSelect('f_cdf_o', data.cdf_destino_original, prevValues.cdf_o);
        fillSelect('f_cdf_f', data.cdf_destino_final, prevValues.cdf_f);
      });
}

function fillSelect(id, arr, selectedVal) {
    const sel = document.getElementById(id);
    // Preservar valor actual si el usuario lo cambi√≥ antes del fetch
    const current = sel.value || selectedVal;
    
    sel.innerHTML = '<option value="">-- Todos --</option>' +
        (arr||[]).map(v => `<option value="${v}">${v}</option>`).join('');
    
    // Restaurar selecci√≥n
    if(current) sel.value = current;
}

// Listeners para encadenamiento
['f_unidad', 'f_estado', 'f_zona'].forEach(id => {
    document.getElementById(id).addEventListener('change', loadOptions);
});

// Carga inicial
document.addEventListener('DOMContentLoaded', loadOptions);

// --- Funciones de Navegaci√≥n ---

function consultarPantalla() {
    document.getElementById('page_input').value = "1";
    document.getElementById('form-filtros').submit();
}

function irAPagina(num) {
    document.getElementById('page_input').value = num;
    document.getElementById('form-filtros').submit();
}

// Bot√≥n Descargar CSV
const btnCsv = document.getElementById('btn-csv');
if (btnCsv) {
    btnCsv.addEventListener('click', () => {
        const f = document.getElementById('form-filtros');
        // Validar columnas
        if (document.querySelectorAll('input[name="columnas"]:checked').length === 0) {
            alert("Selecciona al menos una columna.");
            return;
        }
        const params = new URLSearchParams(new FormData(f));
        params.append('csv', '1');
        params.delete('page');
        window.location = '?' + params.toString();
    });
}

function seleccionarTodos(valor) {
    document.querySelectorAll('input[name="columnas"]').forEach(c => c.checked = valor);
}
</script>
{% endblock %}