{% extends 'fertilizantes/base.html' %}
{% load static %}

{% block title %}OCR RÃ¡pido â€“ Extraer texto{% endblock %}

{% block content %}
<h2>ðŸ§¾ OCR RÃ¡pido â€“ Extraer texto plano</h2>

<div class="mb-3 text-muted small">
  Pega con <strong>âŒ˜/Ctrl + V</strong> o <strong>arrastra</strong> una imagen/PDF al recuadro.
  Luego pulsa <em>Procesar</em>. Para folios/cÃ³digos usa PSM=7 y whitelist.
</div>

<!-- Controles -->
<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
  <div>
    <label class="form-label small mb-1">Idioma</label>
    <select id="lang" class="form-select form-select-sm">
      <option value="spa+eng" selected>EspaÃ±ol + InglÃ©s</option>
      <option value="spa">EspaÃ±ol</option>
      <option value="eng">InglÃ©s</option>
    </select>
  </div>
  <div>
    <label class="form-label small mb-1">PSM</label>
    <select id="psm" class="form-select form-select-sm">
      <option value="6" selected>6 â€“ Bloques de texto</option>
      <option value="7">7 â€“ LÃ­nea Ãºnica / folios</option>
      <option value="4">4 â€“ PÃ¡rrafos</option>
      <option value="11">11 â€“ Texto disperso</option>
    </select>
  </div>
  <div>
    <label class="form-label small mb-1">Whitelist</label>
    <input id="whitelist" class="form-control form-control-sm" placeholder="A-Z0-9-/" />
  </div>

  <button id="process" class="btn btn-sm btn-primary">Procesar</button>
  <span id="status" class="small text-muted ms-2"></span>
</div>

<!-- Zona de Drop/Paste -->
<div id="drop" class="border border-2 border-secondary-subtle rounded-3 p-4 text-center bg-light mb-3"
     style="cursor:pointer;">
  <p class="mb-2"><strong>Arrastra y suelta</strong> una imagen o PDF aquÃ­, o haz clic para seleccionar.</p>
  <p class="text-muted small mb-0">TambiÃ©n puedes pegar directamente desde el portapapeles (âŒ˜/Ctrl + V).</p>
  <input id="file" type="file" accept="image/*,.pdf" hidden>
  <div class="mt-3">
    <img id="preview" class="img-fluid d-none rounded" alt="preview" style="max-height:200px;">
  </div>
</div>

<!-- Resultado -->
<div class="mb-2 d-flex gap-2">
  <button id="copy" class="btn btn-sm btn-outline-secondary">Copiar</button>
  <button id="save" class="btn btn-sm btn-outline-secondary">Guardar .txt</button>
  <button id="clear" class="btn btn-sm btn-outline-secondary">Limpiar</button>
</div>

<textarea id="output" class="form-control" style="min-height: 320px;"
          placeholder="AquÃ­ aparecerÃ¡ el texto extraÃ­doâ€¦"></textarea>

<style>
  /* Ajustes sutiles como en tus tablas */
  #drop.dragover {
    border-color: #86b7fe !important;
    background: #eef6ff !important;
  }
  textarea#output {
    font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    font-size: .85rem;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('file');
  const preview = document.getElementById('preview');
  const processBtn = document.getElementById('process');
  const out = document.getElementById('output');
  const status = document.getElementById('status');

  let cachedFile = null;       // archivo arrastrado/seleccionado
  let clipboardDataURL = null; // imagen pegada como dataURL

  // CSRF (Django cookie)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function setStatus(msg){ status.textContent = msg || ""; }
  function resetPreview(){ preview.classList.add('d-none'); preview.src=""; }

  // Click para abrir selector
  drop.addEventListener('click', ()=> fileInput.click());

  // Drag & Drop
  ['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, e=>{
    e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover');
  }));
  ['dragleave','drop'].forEach(evt => drop.addEventListener(evt, e=>{
    e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover');
  }));
  drop.addEventListener('drop', e=>{
    const f = e.dataTransfer.files?.[0];
    if (!f) return;
    cachedFile = f; clipboardDataURL = null;
    if (f.type.startsWith('image/')) {
      const r = new FileReader();
      r.onload = () => { preview.src = r.result; preview.classList.remove('d-none'); };
      r.readAsDataURL(f);
    } else {
      resetPreview(); // PDF: sin preview
    }
    setStatus(`Listo: ${f.name}`);
  });

  // SelecciÃ³n manual
  fileInput.addEventListener('change', e=>{
    const f = e.target.files?.[0];
    if (!f) return;
    cachedFile = f; clipboardDataURL = null;
    if (f.type.startsWith('image/')) {
      const r = new FileReader();
      r.onload = () => { preview.src = r.result; preview.classList.remove('d-none'); };
      r.readAsDataURL(f);
    } else {
      resetPreview();
    }
    setStatus(`Listo: ${f.name}`);
  });

  // Pegar desde portapapeles
  window.addEventListener('paste', async (e)=>{
    const items = e.clipboardData?.items || [];
    for (const it of items) {
      if (it.type.startsWith('image/')) {
        const blob = it.getAsFile();
        const r = new FileReader();
        r.onload = ()=> {
          clipboardDataURL = r.result;  // data:image/...
          cachedFile = null;
          preview.src = clipboardDataURL; preview.classList.remove('d-none');
          setStatus('Imagen pegada desde el portapapeles.');
        };
        r.readAsDataURL(blob);
        return;
      } else if (it.type === 'application/pdf') {
        const blob = it.getAsFile();
        cachedFile = new File([blob], "clipboard.pdf", {type: "application/pdf"});
        clipboardDataURL = null;
        resetPreview();
        setStatus('PDF pegado desde el portapapeles.');
        return;
      }
    }
  });

  async function processOCR(){
    setStatus('Procesandoâ€¦');
    processBtn.disabled = true;
    const lang = document.getElementById('lang').value;
    const psm = document.getElementById('psm').value;
    const whitelist = document.getElementById('whitelist').value.trim();

    const form = new FormData();
    form.append('lang', lang);
    form.append('psm', psm);
    if (whitelist) form.append('whitelist', whitelist);

    if (cachedFile) {
      form.append('file', cachedFile, cachedFile.name);
    } else if (clipboardDataURL) {
      form.append('clipboard_data', clipboardDataURL);
    } else {
      setStatus('Selecciona o pega una imagen/PDF primero.');
      processBtn.disabled = false;
      return;
    }

    try {
      const res = await fetch("{% url 'ocr_extract' %}", {
        method: "POST",
        headers: {'X-CSRFToken': csrftoken},
        body: form
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      out.value = (data.text || '').trim();
      setStatus('Listo âœ…');
    } catch (err) {
      console.error(err);
      setStatus('Error en OCR: ' + err.message);
    } finally {
      processBtn.disabled = false;
    }
  }

  document.getElementById('process').addEventListener('click', processOCR);

  document.getElementById('copy').addEventListener('click', async ()=>{
    await navigator.clipboard.writeText(out.value || '');
    setStatus('Texto copiado al portapapeles.');
  });

  document.getElementById('save').addEventListener('click', ()=>{
    const blob = new Blob([out.value || ""], {type: "text/plain;charset=utf-8"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "ocr.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById('clear').addEventListener('click', ()=>{
    out.value = ""; cachedFile = null; clipboardDataURL = null; resetPreview(); setStatus('');
  });
});
</script>
{% endblock %}