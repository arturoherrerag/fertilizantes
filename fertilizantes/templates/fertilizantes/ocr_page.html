{% extends 'fertilizantes/base.html' %}
{% load static %}

{% block title %}Herramienta OCR{% endblock %}

{% block content %}

<div class="container mt-4 mb-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold" style="color: #264e46;">
                <i class="bi bi-upc-scan me-2"></i>Extractor de Texto (OCR)
            </h1>
            <p class="text-secondary mb-0">
                Digitaliza texto de im√°genes o PDFs (escaneados, fotos, capturas).
            </p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body p-0">
                    <div id="drop-zone" class="p-5 text-center" 
                         style="border: 2px dashed #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                        
                        <div id="drop-content">
                            <i class="bi bi-cloud-arrow-up text-primary" style="font-size: 3rem;"></i>
                            <h6 class="mt-3 fw-bold text-secondary">Arrastra archivos aqu√≠</h6>
                            <p class="text-muted small mb-0">o haz clic para buscar</p>
                            <p class="text-muted small mt-2">
                                <span class="badge bg-light text-dark border">Ctrl + V</span> para pegar captura
                            </p>
                        </div>

                        <div id="preview-container" class="d-none">
                            <img id="preview-img" class="img-fluid rounded shadow-sm mb-2" style="max-height: 200px;">
                            <div id="file-info" class="small fw-bold text-success mb-2"></div>
                            <button id="btn-change" class="btn btn-sm btn-outline-secondary">Cambiar archivo</button>
                        </div>

                        <input id="file-input" type="file" accept="image/*,.pdf" hidden>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 bg-light">
                <div class="card-body">
                    <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-sliders me-2"></i>Configuraci√≥n</h6>
                    
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small fw-bold text-muted">Idioma</label>
                            <select id="cfg-lang" class="form-select form-select-sm">
                                <option value="spa+eng">Espa√±ol + Ingl√©s</option>
                                <option value="spa">Espa√±ol</option>
                                <option value="eng">Ingl√©s</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold text-muted">Modo (PSM)</label>
                            <select id="cfg-psm" class="form-select form-select-sm">
                                <option value="3">Autom√°tico (Default)</option>
                                <option value="6">Bloque de texto uniforme</option>
                                <option value="7">Una sola l√≠nea (Folios)</option>
                                <option value="4">Columna √∫nica</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Lista Blanca (Opcional)</label>
                            <input id="cfg-whitelist" class="form-control form-control-sm" placeholder="Ej: 0123456789ABC (Solo permite estos caracteres)">
                            <div class="form-text small">√ötil para extraer solo n√∫meros de folios o c√≥digos.</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button id="btn-process" class="btn btn-primary" style="background-color: #264e46;" disabled>
                            <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <span id="btn-text">Extraer Texto</span>
                        </button>
                    </div>
                    <div id="status-msg" class="text-center mt-2 small text-muted"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-file-text me-2"></i>Resultado</h6>
                    <div class="btn-group">
                        <button id="btn-copy" class="btn btn-sm btn-outline-secondary" title="Copiar al portapapeles">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button id="btn-save" class="btn btn-sm btn-outline-secondary" title="Guardar como .txt">
                            <i class="bi bi-download"></i>
                        </button>
                        <button id="btn-clear" class="btn btn-sm btn-outline-danger" title="Limpiar todo">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <textarea id="output-text" class="form-control border-0 h-100 p-3" 
                              style="resize: none; font-family: 'Courier New', monospace; font-size: 0.9rem; min-height: 400px;"
                              placeholder="El texto extra√≠do aparecer√° aqu√≠..."></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    
    // Elementos del DOM
    const dropZone = document.getElementById('drop-zone');
    const dropContent = document.getElementById('drop-content');
    const fileInput = document.getElementById('file-input');
    const previewContainer = document.getElementById('preview-container');
    const previewImg = document.getElementById('preview-img');
    const fileInfo = document.getElementById('file-info');
    const btnChange = document.getElementById('btn-change');
    const btnProcess = document.getElementById('btn-process');
    const outputText = document.getElementById('output-text');
    const statusMsg = document.getElementById('status-msg');
    
    // Variables de estado
    let activeFile = null;
    let activeClipboardData = null; // Para guardar base64 si se pega

    // CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- Manejo de Drag & Drop y Archivos ---

    function handleFile(file) {
        if (!file) return;
        
        activeFile = file;
        activeClipboardData = null; // Reset clipboard
        
        // Mostrar info
        fileInfo.textContent = `üìÑ ${file.name}`;
        
        // Mostrar preview si es imagen
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                previewImg.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        } else {
            // Es PDF u otro
            previewImg.classList.add('d-none'); // Ocultar imagen, mostrar solo nombre
        }

        // Cambiar UI
        dropContent.classList.add('d-none');
        previewContainer.classList.remove('d-none');
        btnProcess.disabled = false;
        dropZone.style.borderColor = "#264e46";
        statusMsg.textContent = "Listo para procesar.";
        statusMsg.className = "text-center mt-2 small text-success fw-bold";
    }

    function resetUI() {
        activeFile = null;
        activeClipboardData = null;
        fileInput.value = "";
        previewImg.src = "";
        
        dropContent.classList.remove('d-none');
        previewContainer.classList.add('d-none');
        btnProcess.disabled = true;
        dropZone.style.borderColor = "#dee2e6";
        dropZone.style.backgroundColor = "white";
        statusMsg.textContent = "";
        outputText.value = "";
    }

    // Eventos Drag & Drop
    dropZone.addEventListener('click', (e) => {
        if(e.target !== btnChange) fileInput.click();
    });

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = "#eef6f5"; // Un verde muy suave
        dropZone.style.borderColor = "#264e46";
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        if (!activeFile && !activeClipboardData) {
            dropZone.style.backgroundColor = "white";
            dropZone.style.borderColor = "#dee2e6";
        }
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    btnChange.addEventListener('click', (e) => {
        e.stopPropagation();
        resetUI();
    });

    // --- Manejo del Portapapeles (Paste) ---
    window.addEventListener('paste', (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file') {
                const blob = item.getAsFile();
                
                // Si es imagen, la mostramos
                if (item.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        activeClipboardData = event.target.result; // DataURL
                        activeFile = null;
                        
                        previewImg.src = activeClipboardData;
                        previewImg.classList.remove('d-none');
                        fileInfo.textContent = "üì∏ Captura desde portapapeles";
                        
                        dropContent.classList.add('d-none');
                        previewContainer.classList.remove('d-none');
                        btnProcess.disabled = false;
                        dropZone.style.borderColor = "#264e46";
                        statusMsg.textContent = "Imagen pegada detectada.";
                    };
                    reader.readAsDataURL(blob);
                } 
                // Si es PDF
                else if (item.type === 'application/pdf') {
                    // Tratar como archivo
                    const pdfFile = new File([blob], "pegado.pdf", { type: "application/pdf" });
                    handleFile(pdfFile);
                }
            }
        }
    });

    // --- Procesamiento (Enviar al Backend) ---
    btnProcess.addEventListener('click', async () => {
        const btnText = document.getElementById('btn-text');
        const spinner = document.getElementById('spinner');
        
        // UI Loading
        btnProcess.disabled = true;
        btnText.textContent = "Procesando...";
        spinner.classList.remove('d-none');
        statusMsg.textContent = "Enviando datos al servidor...";
        statusMsg.className = "text-center mt-2 small text-muted";

        const formData = new FormData();
        
        // Agregar configuraci√≥n
        formData.append('lang', document.getElementById('cfg-lang').value);
        formData.append('psm', document.getElementById('cfg-psm').value);
        formData.append('whitelist', document.getElementById('cfg-whitelist').value);

        // Agregar archivo o datos
        if (activeFile) {
            formData.append('file', activeFile);
        } else if (activeClipboardData) {
            formData.append('clipboard_data', activeClipboardData);
        }

        try {
            const response = await fetch("{% url 'ocr_extract' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });

            if (!response.ok) {
                const errData = await response.text();
                throw new Error(errData || "Error en el servidor");
            }

            const data = await response.json();
            
            // √âxito
            outputText.value = data.texto;
            statusMsg.textContent = "¬°Texto extra√≠do con √©xito!";
            statusMsg.className = "text-center mt-2 small text-success fw-bold";

        } catch (error) {
            console.error(error);
            outputText.value = `ERROR:\n${error.message}`;
            statusMsg.textContent = "Ocurri√≥ un error. Intenta de nuevo.";
            statusMsg.className = "text-center mt-2 small text-danger fw-bold";
        } finally {
            // Restaurar bot√≥n
            btnProcess.disabled = false;
            btnText.textContent = "Extraer Texto";
            spinner.classList.add('d-none');
        }
    });

    // --- Botones de Acci√≥n (Resultado) ---
    document.getElementById('btn-copy').addEventListener('click', () => {
        outputText.select();
        document.execCommand('copy'); // Fallback o usar navigator.clipboard
        statusMsg.textContent = "Texto copiado al portapapeles.";
    });

    document.getElementById('btn-save').addEventListener('click', () => {
        const blob = new Blob([outputText.value], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "texto_extraido.txt";
        link.click();
    });

    document.getElementById('btn-clear').addEventListener('click', () => {
        resetUI();
    });

});
</script>
{% endblock %}